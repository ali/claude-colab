{"id":"cc-4m6","title":"Initial Repo Setup \u0026 Refactoring","description":"Initialize git repo, refactor notebook to use external skill files, and setup build process.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-14T17:09:05.914633-05:00","updated_at":"2025-12-14T21:40:00.873636-05:00","closed_at":"2025-12-14T21:40:00.873636-05:00"}
{"id":"cc-commands","title":"Custom slash commands with proper frontmatter","description":"**Start by reading:** `src/cached_docs/slash-commands.md`\n\nCreate well-structured slash commands using official patterns.\n\n## Dependencies \u0026 Integration Analysis\n\n### External Dependencies\n1. **Claude Code Command System**\n   - Commands are Markdown files with YAML frontmatter\n   - Location: `commands/` directory in plugin root\n   - Supports `$ARGUMENTS`, `$1`, `$2` for arguments\n   - `!command` syntax for bash execution in context\n   - `@file` syntax for file inclusion\n\n2. **Git** (for /commit command)\n   - Standard git CLI available in Colab\n   - User may or may not have configured git identity\n\n3. **nvidia-smi** (for /colab-status)\n   - Available when GPU runtime is selected\n   - Returns exit code 0 when GPU present\n\n4. **Colab Filesystem**\n   - `/content/` is ephemeral\n   - `/content/drive/My Drive/` is persistent if mounted\n\n### Internal Dependencies\n- None directly, but logically follows claude-collab-settings\n\n### What Depends On This\n- **claude-collab-plugin** (P1): Bundles these commands\n- Users invoking commands in sessions\n\n## Command Specifications\n\n### 1. /commit - Git Commit Helper\n\n**Purpose:** Create well-formatted git commits with AI-generated messages\n\n**File:** `src/plugin/commands/commit.md`\n\n```markdown\n---\nallowed-tools: Bash(git add:*), Bash(git status:*), Bash(git diff:*), Bash(git commit:*), Bash(git log:*)\ndescription: Create a git commit with AI-generated message\nargument-hint: [optional message hint]\n---\n\n# Git Commit\n\n## Current State\n- Status: !`git status --short`\n- Staged changes: !`git diff --cached --stat`\n- Unstaged changes: !`git diff --stat`\n- Recent commits: !`git log --oneline -5 2\u003e/dev/null || echo \"No commits yet\"`\n\n## Instructions\n\nCreate a git commit based on the staged changes above.\n\nIf changes aren't staged yet, ask which files to stage.\n\n$ARGUMENTS\n\n**Commit message format:**\n- First line: imperative mood, \u003c50 chars (e.g., \"Add user authentication\")\n- Blank line\n- Body: explain what and why (not how)\n- Keep it concise\n\n**Do not:**\n- Commit .env files, credentials, or secrets\n- Force push or amend without explicit request\n```\n\n### 2. /checkpoint - Save Colab State\n\n**Purpose:** Create a checkpoint of current work before disconnect\n\n**File:** `src/plugin/commands/checkpoint.md`\n\n```markdown\n---\nallowed-tools: Bash(mkdir:*), Bash(cp:*), Bash(ls:*), Bash(tar:*), Bash(date:*), Read, Write\ndescription: Save checkpoint of Colab workspace state\nargument-hint: [checkpoint-name]\n---\n\n# Checkpoint Colab State\n\nSave current workspace state to a checkpoint for recovery after disconnect.\n\n## Current Environment\n- Working directory: !`pwd`\n- Drive mounted: !`[ -d \"/content/drive/My Drive\" ] \u0026\u0026 echo \"Yes\" || echo \"No\"`\n\n## Instructions\n\nCreate a checkpoint with name: $ARGUMENTS (or use timestamp if not provided)\n\n**Steps:**\n1. Determine checkpoint location:\n   - If Drive mounted: `/content/drive/My Drive/claude-checkpoints/`\n   - Otherwise: `/content/checkpoints/` (warn about ephemerality)\n\n2. Create checkpoint directory with timestamp:\n   ```\n   checkpoints/\n   └── {name}_{YYYYMMDD_HHMMSS}/\n       ├── workspace/     # .py, .ipynb, .md, .json files\n       ├── config/        # .claude/ directory\n       └── manifest.json  # metadata\n   ```\n\n3. Copy relevant files (exclude node_modules, __pycache__, .git, venv, large data)\n\n4. Create manifest.json with:\n   - Timestamp\n   - File list with sizes\n   - Python version\n   - pip freeze output\n   - GPU info\n\n5. Report what was saved and where\n\n**If no Drive and ephemeral warning needed:**\n\"⚠️ Checkpoint saved to /content/ which resets on disconnect. Consider mounting Drive.\"\n```\n\n### 3. /colab-status - Environment Status\n\n**Purpose:** Show comprehensive Colab environment information\n\n**File:** `src/plugin/commands/colab-status.md`\n\n```markdown\n---\nallowed-tools: Bash(nvidia-smi:*), Bash(python:*), Bash(pip:*), Bash(df:*), Bash(free:*), Bash(cat:*), Bash(which:*)\ndescription: Show Colab environment status (GPU, memory, storage)\nargument-hint: [verbose]\n---\n\n# Colab Environment Status\n\n## Quick Status\n- GPU: !`nvidia-smi --query-gpu=name,memory.total,memory.used --format=csv,noheader 2\u003e/dev/null || echo \"None (CPU runtime)\"`\n- Python: !`python --version 2\u003e\u00261`\n- Memory: !`free -h | grep Mem | awk '{print $3 \"/\" $2 \" used\"}'`\n- Disk: !`df -h /content | tail -1 | awk '{print $3 \"/\" $2 \" used (\" $5 \")\"}'`\n\n## Instructions\n\nDisplay a formatted status report of the Colab environment.\n\n$ARGUMENTS\n\n**Include:**\n1. **GPU** (if available):\n   - Name and VRAM\n   - Current utilization\n   - CUDA version\n\n2. **Memory**:\n   - RAM total/used/available\n   - Swap if applicable\n\n3. **Storage**:\n   - /content usage\n   - Drive mount status and usage\n\n4. **Python Environment**:\n   - Version\n   - Key packages (torch, tensorflow, numpy versions)\n\n5. **Claude Code**:\n   - Version (claude --version)\n   - Installed hooks/commands\n\nIf `verbose` argument provided, also show:\n- Full pip list\n- Environment variables (excluding secrets)\n- Installed apt packages\n```\n\n## Integration Points\n\n### 1. Plugin Command Loading\n- Commands in `commands/` directory auto-discovered\n- Namespaced as `/plugin-name:command` if conflicts\n- Claude can invoke via SlashCommand tool\n\n### 2. Frontmatter Fields\n| Field | Purpose | Example |\n|-------|---------|---------|\n| `allowed-tools` | Whitelist tools for command | `Bash(git:*)` |\n| `description` | Shown in /help | \"Create git commit\" |\n| `argument-hint` | Autocomplete hint | `[message]` |\n| `model` | Override model | `claude-3-5-haiku-20241022` |\n\n### 3. Variable Substitution\n- `$ARGUMENTS`: Full argument string\n- `$1`, `$2`, etc.: Positional arguments\n- `!command`: Execute and include output\n- `@file`: Include file contents\n\n## Edge Cases\n\n### /commit\n1. **No git repo**: Detect and offer to initialize\n2. **No staged changes**: Prompt to stage or show status\n3. **Merge conflicts**: Detect and warn, don't commit\n4. **Large diffs**: Summarize, don't include full diff in context\n\n### /checkpoint\n1. **No Drive, ephemeral warning**: Clear warning about data loss\n2. **Large files**: Skip files \u003e100MB, report them\n3. **Permission errors**: Handle gracefully, report what succeeded\n4. **Existing checkpoint**: Append timestamp to avoid overwrite\n\n### /colab-status\n1. **No GPU**: Graceful message about CPU runtime\n2. **nvidia-smi fails**: Catch and report cleanly\n3. **Drive not mounted**: Report as \"Not mounted\"\n4. **Secrets in env**: Filter out CLAUDE_*, API_KEY, TOKEN, etc.\n\n## Testing\n\n```bash\n# Test command file parsing (check frontmatter)\nhead -20 src/plugin/commands/commit.md\n\n# Test in Claude Code\n/commit --help  # Should show description\n/colab-status   # Should show env info\n```\n\n## Files to Create\n- `src/plugin/commands/commit.md`\n- `src/plugin/commands/checkpoint.md`\n- `src/plugin/commands/colab-status.md`\n\n## Build Integration\nUpdate `build.py` to:\n- Copy commands to plugin structure\n- Include in generated notebook (for non-plugin fallback)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-14T18:01:01.610764-05:00","updated_at":"2025-12-15T01:11:13.050178-05:00","closed_at":"2025-12-15T01:11:13.050178-05:00"}
{"id":"cc-docs","title":"Expand docs manifest with missing essential docs","description":"**Start by reading:** Current `src/docs_manifest.json`\n\nAdd missing essential docs to the manifest for download.\n\n## Dependencies \u0026 Integration Analysis\n\n### External Dependencies\n1. **Claude Code Documentation Site**\n   - Base URL: https://code.claude.com/docs/en/\n   - Sitemap: https://code.claude.com/docs/llms.txt\n   - Markdown files with metadata headers\n\n2. **update_docs.py Script**\n   - Downloads docs from manifest URLs\n   - Adds metadata headers (source, title, date)\n   - Handles local (non-URL) entries\n\n3. **Skills/Agents Referencing Docs**\n   - `@src/cached_docs/filename.md` syntax in skill files\n   - Claude reads these for context\n\n### Internal Dependencies\n- None (independent doc-fetching task)\n\n### What Depends On This\n- `src/skills/claude-expert.md` - References cached docs\n- `src/skills/docs-updater.md` - Lists available docs\n- Any skill/agent using `@src/cached_docs/` references\n\n## Current Manifest Analysis\n\n**Currently in manifest (8 docs):**\n1. `overview.md` - Getting started\n2. `settings.md` - Configuration reference\n3. `hooks.md` - Hooks system\n4. `statusline.md` - Status line config\n5. `auth.md` - Authentication (local)\n6. `plugins-reference.md` - Plugin system\n7. `cli-reference.md` - CLI commands\n8. `slash-commands.md` - Slash commands\n\n**Missing essential docs:**\n1. `mcp.md` - MCP server configuration\n2. `sub-agents.md` - Custom subagents\n3. `skills.md` - Agent skills system\n4. `memory.md` - CLAUDE.md and memory\n5. `common-workflows.md` - Workflow patterns\n\n## Integration Points\n\n### 1. Manifest JSON Structure\n```json\n{\n  \"base_url\": \"https://code.claude.com/docs/en\",\n  \"sitemap_url\": \"https://code.claude.com/docs/llms.txt\",\n  \"last_updated\": \"2025-12-14T17:45:44.334247\",\n  \"docs\": [\n    {\n      \"filename\": \"example.md\",\n      \"url\": \"https://code.claude.com/docs/en/example.md\",\n      \"title\": \"Example Title\",\n      \"description\": \"Brief description\"\n    }\n  ]\n}\n```\n\n### 2. Skill File References\n```markdown\n# In SKILL.md files\nFor details, see @src/cached_docs/mcp.md\n```\n\n### 3. Bootstrap Notebook Integration\n- Docs are copied to workspace during bootstrap\n- update_docs.py script is embedded in notebook\n- User can re-run to fetch latest docs\n\n## Docs to Add\n\n### 1. mcp.md\n```json\n{\n  \"filename\": \"mcp.md\",\n  \"url\": \"https://code.claude.com/docs/en/mcp.md\",\n  \"title\": \"Model Context Protocol\",\n  \"description\": \"Configure and manage MCP servers for external tool integration\"\n}\n```\n\n**Why needed:**\n- MCP servers extend Claude Code capabilities\n- Colab users may want to add custom MCP servers\n- Enterprise MCP configuration info\n\n### 2. sub-agents.md\n```json\n{\n  \"filename\": \"sub-agents.md\",\n  \"url\": \"https://code.claude.com/docs/en/sub-agents.md\",\n  \"title\": \"Subagents\",\n  \"description\": \"Create and use custom AI subagents for specialized tasks\"\n}\n```\n\n**Why needed:**\n- We bundle custom agents (colab.md, notebook-doctor.md)\n- Users may want to create their own\n- Explains agent frontmatter format\n\n### 3. skills.md\n```json\n{\n  \"filename\": \"skills.md\",\n  \"url\": \"https://code.claude.com/docs/en/skills.md\",\n  \"title\": \"Agent Skills\",\n  \"description\": \"Extend Claude's capabilities with custom skills\"\n}\n```\n\n**Why needed:**\n- We bundle skills (claude-expert, ipynb, etc.)\n- Explains SKILL.md format\n- Skills vs slash commands comparison\n\n### 4. memory.md\n```json\n{\n  \"filename\": \"memory.md\",\n  \"url\": \"https://code.claude.com/docs/en/memory.md\",\n  \"title\": \"Memory Management\",\n  \"description\": \"CLAUDE.md files and memory management across sessions\"\n}\n```\n\n**Why needed:**\n- Bootstrap creates CLAUDE.md\n- Explains memory hierarchy\n- # shortcut and memory commands\n\n### 5. common-workflows.md\n```json\n{\n  \"filename\": \"common-workflows.md\",\n  \"url\": \"https://code.claude.com/docs/en/common-workflows.md\",\n  \"title\": \"Common Workflows\",\n  \"description\": \"Patterns for common coding tasks with Claude Code\"\n}\n```\n\n**Why needed:**\n- Best practices reference\n- Extended thinking usage\n- File reference patterns\n\n## Updated Manifest\n\n```json\n{\n  \"base_url\": \"https://code.claude.com/docs/en\",\n  \"sitemap_url\": \"https://code.claude.com/docs/llms.txt\",\n  \"last_updated\": \"2025-12-14T17:45:44.334247\",\n  \"docs\": [\n    {\n      \"filename\": \"overview.md\",\n      \"url\": \"https://code.claude.com/docs/en/overview.md\",\n      \"title\": \"Claude Code Overview\",\n      \"description\": \"Getting started guide and overview of Claude Code\"\n    },\n    {\n      \"filename\": \"settings.md\",\n      \"url\": \"https://code.claude.com/docs/en/settings.md\",\n      \"title\": \"Claude Code Settings\",\n      \"description\": \"Configuration reference for settings.json, permissions, hooks, and environment variables\"\n    },\n    {\n      \"filename\": \"hooks.md\",\n      \"url\": \"https://code.claude.com/docs/en/hooks.md\",\n      \"title\": \"Hooks Reference\",\n      \"description\": \"Documentation for implementing hooks in Claude Code\"\n    },\n    {\n      \"filename\": \"statusline.md\",\n      \"url\": \"https://code.claude.com/docs/en/statusline.md\",\n      \"title\": \"Status Line Configuration\",\n      \"description\": \"How to create and configure custom status lines\"\n    },\n    {\n      \"filename\": \"auth.md\",\n      \"url\": \"local\",\n      \"title\": \"Authentication Guide\",\n      \"description\": \"Authentication methods and token management (local documentation)\"\n    },\n    {\n      \"filename\": \"plugins-reference.md\",\n      \"url\": \"https://code.claude.com/docs/en/plugins-reference.md\",\n      \"title\": \"Plugins Reference\",\n      \"description\": \"Complete technical reference for Claude Code plugin system\"\n    },\n    {\n      \"filename\": \"cli-reference.md\",\n      \"url\": \"https://code.claude.com/docs/en/cli-reference.md\",\n      \"title\": \"CLI Reference\",\n      \"description\": \"Complete reference for Claude Code command-line interface\"\n    },\n    {\n      \"filename\": \"slash-commands.md\",\n      \"url\": \"https://code.claude.com/docs/en/slash-commands.md\",\n      \"title\": \"Slash Commands\",\n      \"description\": \"Control Claude's behavior with slash commands\"\n    },\n    {\n      \"filename\": \"mcp.md\",\n      \"url\": \"https://code.claude.com/docs/en/mcp.md\",\n      \"title\": \"Model Context Protocol\",\n      \"description\": \"Configure and manage MCP servers for external tool integration\"\n    },\n    {\n      \"filename\": \"sub-agents.md\",\n      \"url\": \"https://code.claude.com/docs/en/sub-agents.md\",\n      \"title\": \"Subagents\",\n      \"description\": \"Create and use custom AI subagents for specialized tasks\"\n    },\n    {\n      \"filename\": \"skills.md\",\n      \"url\": \"https://code.claude.com/docs/en/skills.md\",\n      \"title\": \"Agent Skills\",\n      \"description\": \"Extend Claude's capabilities with custom skills\"\n    },\n    {\n      \"filename\": \"memory.md\",\n      \"url\": \"https://code.claude.com/docs/en/memory.md\",\n      \"title\": \"Memory Management\",\n      \"description\": \"CLAUDE.md files and memory management across sessions\"\n    },\n    {\n      \"filename\": \"common-workflows.md\",\n      \"url\": \"https://code.claude.com/docs/en/common-workflows.md\",\n      \"title\": \"Common Workflows\",\n      \"description\": \"Patterns for common coding tasks with Claude Code\"\n    }\n  ]\n}\n```\n\n## Skill Updates Required\n\n### claude-expert.md\nAdd references to new docs:\n```markdown\n## Documentation References\n- @src/cached_docs/mcp.md - MCP server configuration\n- @src/cached_docs/sub-agents.md - Custom subagents\n- @src/cached_docs/skills.md - Agent skills system\n- @src/cached_docs/memory.md - Memory and CLAUDE.md\n- @src/cached_docs/common-workflows.md - Workflow patterns\n```\n\n### docs-updater.md\nUpdate list of available docs for self-awareness.\n\n## Edge Cases\n\n1. **URL Returns 404**\n   - update_docs.py should handle gracefully\n   - Log warning, continue with other docs\n   - Check sitemap first to verify URLs exist\n\n2. **Sitemap Changes**\n   - Periodically check sitemap for new docs\n   - Consider auto-discovery mode\n\n3. **Large Doc Files**\n   - Some docs may be large (\u003e100KB)\n   - Consider truncating or splitting\n\n4. **Rate Limiting**\n   - Be polite to Claude Code docs server\n   - Add small delays between fetches\n\n## Verification Steps\n\n1. Check sitemap for exact URLs:\n   ```bash\n   curl https://code.claude.com/docs/llms.txt | grep -E \"(mcp|sub-agents|skills|memory|common-workflows)\"\n   ```\n\n2. Run update script:\n   ```bash\n   python3 update_docs.py\n   ```\n\n3. Verify files downloaded:\n   ```bash\n   ls -la src/cached_docs/\n   ```\n\n4. Test skill references:\n   - Open Claude Code in test project\n   - Check @src/cached_docs/mcp.md resolves\n\n## Files to Modify\n- `src/docs_manifest.json` - Add new doc entries\n- `src/skills/claude-expert.md` - Add new doc references\n- `src/skills/docs-updater.md` - Update doc list\n\n## Docs Explicitly NOT Included\n- **IAM docs**: Overkill for personal Colab environment\n- **Enterprise docs**: Not relevant for Colab users\n- **Bedrock/Vertex docs**: Provider-specific, can add later if needed","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-14T18:01:04.188758-05:00","updated_at":"2025-12-14T21:09:23.427763-05:00"}
{"id":"cc-plugin","title":"Restructure as plugin with repo as marketplace","description":"**Start by reading:** `src/cached_docs/plugins-reference.md`\n\nRestructure the Colab setup as a proper Claude Code plugin, with this repo serving as the marketplace.\n\n**Plugin structure to create:**\n```\nsrc/plugin/\n├── .claude-plugin/\n│   └── plugin.json      # name, version, description, author, etc.\n├── commands/\n│   ├── commit.md\n│   ├── checkpoint.md\n│   └── colab-status.md\n├── agents/\n│   ├── notebook-doctor.md\n│   └── colab.md\n├── skills/\n│   ├── claude-expert/SKILL.md\n│   ├── ipynb/SKILL.md\n│   └── customize/SKILL.md\n└── hooks/\n    └── hooks.json       # Hook configurations\n```\n\n**Marketplace setup:**\n- This GitHub repo IS the marketplace\n- Bootstrap notebook adds repo to `extraKnownMarketplaces` in settings\n- Users get updates by re-running bootstrap (fetches latest plugin version)\n\n**Bootstrap changes:**\n- Add `extraKnownMarketplaces` pointing to this repo\n- Enable plugin via `enabledPlugins` setting\n- Plugin installs commands, agents, skills, hooks automatically\n\n**Files to create/modify:**\n- `src/plugin/.claude-plugin/plugin.json`\n- Move/reorganize existing commands, agents, skills into plugin structure\n- `build.py` - Generate notebook that installs plugin\n- Update README.md with plugin installation instructions\n\n---\n\n## ALTERNATIVE PATHS \u0026 EDGE CASES\n\n### Edge Cases to Handle\n\n1. **Plugin Conflicts**\n   - What if user has another plugin with same command names (e.g., `/commit`)?\n   - Use namespaced commands: `/colab:commit` vs `/commit`\n   - Document conflict resolution in the plugin README\n\n2. **Marketplace Trust**\n   - First-time users will be prompted to trust this marketplace\n   - `extraKnownMarketplaces` requires user consent per docs\n   - Handle case where user declines - provide manual install instructions\n\n3. **Offline/Network Failures**\n   - Plugin fetch from GitHub could fail in Colab\n   - Fallback: Embed minimal plugin content in bootstrap notebook\n   - Add retry logic with exponential backoff\n\n4. **Plugin Version Mismatches**\n   - Old bootstrap notebook + new plugin version\n   - Include minimum plugin version in bootstrap config\n   - Graceful degradation for missing new features\n\n### Alternative Implementations\n\n1. **Local Directory Plugin (Fallback)**\n   Instead of GitHub marketplace, support local plugin installation:\n   ```json\n   {\n     \"extraKnownMarketplaces\": {\n       \"colab-local\": {\n         \"source\": {\n           \"source\": \"directory\", \n           \"path\": \"/content/claude-workspaces/.claude-colab-plugin\"\n         }\n       }\n     }\n   }\n   ```\n\n2. **Hybrid Approach**\n   - Embed critical files (hooks, skills) directly in notebook\n   - Use plugin for optional/updatable components (commands, agents)\n   - Reduces single-point-of-failure risk\n\n3. **Self-Updating Plugin**\n   Add a `/update-colab` command that:\n   - Fetches latest plugin.json version\n   - Compares with installed version\n   - Triggers plugin update if newer\n\n### Error Handling Requirements\n\n1. **`` Not Set**\n   - Hooks may fail if variable is undefined\n   - Add check in hook scripts: `if [ -z \"$CLAUDE_PLUGIN_ROOT\" ]; then exit 0; fi`\n\n2. **Script Permissions**\n   - `chmod +x` may fail on mounted Drive\n   - Use Python scripts instead of bash (no execute bit needed)\n   - Or run via `python3 script.py` rather than `./script.py`\n\n3. **JSON Parsing Errors**\n   - Invalid plugin.json should not crash Claude Code\n   - Test with `claude --debug` to verify plugin loads\n\n### Configuration Options\n\n```json\n{\n  \"colab\": {\n    \"autoSetupHooks\": true,\n    \"statusLineEnabled\": true,\n    \"safetyHooksEnabled\": true,\n    \"preferredModel\": \"claude-sonnet-4-5\"\n  }\n}\n```\n\n### Testing Considerations\n\n- Add pytest tests for plugin.json schema validation\n- Test plugin loading with `claude --debug`\n- Test in fresh Colab runtime (no cached state)\n- Test with/without authentication token\n- Test marketplace trust flow\n\nDepends on (5):\n  → claude-collab-settings: Enhanced settings.json configuration for Colab [P1]\n  → claude-collab-session-hook: SessionStart hook for Colab environment setup [P1]\n  → claude-collab-statusline: Enhanced status line with context usage and cost [P2]\n  → claude-collab-safety-hook: PreToolUse validation hook for dangerous commands [P2]\n  → claude-collab-commands: Custom slash commands with proper frontmatter [P2]","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-14T18:01:07.775997-05:00","updated_at":"2025-12-15T01:11:13.048468-05:00","closed_at":"2025-12-15T01:11:13.048468-05:00","dependencies":[{"issue_id":"cc-plugin","depends_on_id":"cc-settings","type":"blocks","created_at":"2025-12-14T18:01:07.776974-05:00","created_by":"daemon"},{"issue_id":"cc-plugin","depends_on_id":"cc-session-hook","type":"blocks","created_at":"2025-12-14T18:01:07.778194-05:00","created_by":"daemon"},{"issue_id":"cc-plugin","depends_on_id":"cc-statusline","type":"blocks","created_at":"2025-12-14T18:01:07.779453-05:00","created_by":"daemon"},{"issue_id":"cc-plugin","depends_on_id":"cc-safety-hook","type":"blocks","created_at":"2025-12-14T18:01:07.780675-05:00","created_by":"daemon"},{"issue_id":"cc-plugin","depends_on_id":"cc-commands","type":"blocks","created_at":"2025-12-14T18:01:07.781498-05:00","created_by":"daemon"}]}
{"id":"cc-pq0","title":"Automate release workflow and trigger first release","description":"The release workflow currently only runs on manually published releases or manual dispatch. Update it to run automatically on tag pushes (v*). Also tag the current version v0.1.0 to trigger the first release.","status":"closed","priority":1,"issue_type":"chore","created_at":"2025-12-14T20:26:53.894303-05:00","updated_at":"2025-12-14T20:28:01.167531-05:00","closed_at":"2025-12-14T20:28:01.167531-05:00"}
{"id":"cc-safety-hook","title":"PreToolUse validation hook for dangerous commands","description":"**Start by reading:** `src/cached_docs/hooks.md` (focus on PreToolUse section, lines 288-302)\n\nCreate a PreToolUse hook that validates bash commands before execution.\n\n## Dependencies \u0026 Integration Analysis\n\n### External Dependencies\n1. **Claude Code PreToolUse Event**\n   - Fires before any tool executes\n   - Can block (exit 2), allow (exit 0), or modify tool input\n   - Receives JSON via stdin with tool_name and tool_input\n   - Matcher supports regex: `Bash` matches Bash tool\n\n2. **Colab Security Context**\n   - Running as root in container\n   - Full filesystem access\n   - Network access (can be restricted by Colab)\n   - No persistent damage possible (ephemeral), BUT Drive can be damaged\n\n### Internal Dependencies\n- **claude-collab-settings** (P1): Hook configuration in settings.json\n\n### What Depends On This\n- **claude-collab-plugin** (P1): Bundles this hook\n- User safety when running autonomous commands\n\n## Hook Input (PreToolUse for Bash)\n\n```json\n{\n  \"session_id\": \"abc123\",\n  \"transcript_path\": \"/path/to/transcript.jsonl\",\n  \"cwd\": \"/content/workspace\",\n  \"permission_mode\": \"default\",\n  \"hook_event_name\": \"PreToolUse\",\n  \"tool_name\": \"Bash\",\n  \"tool_input\": {\n    \"command\": \"rm -rf /content/drive/*\",\n    \"timeout\": 120000\n  },\n  \"tool_use_id\": \"toolu_01ABC...\"\n}\n```\n\n## Hook Output\n\n### Block (Exit Code 2)\n```bash\n# stderr is shown to Claude\necho \"BLOCKED: Refusing to delete Drive contents. This would cause permanent data loss.\" \u003e\u00262\nexit 2\n```\n\n### Allow (Exit Code 0)\n```bash\nexit 0\n```\n\n### Allow with Modification (JSON stdout)\n```json\n{\n  \"hookSpecificOutput\": {\n    \"hookEventName\": \"PreToolUse\",\n    \"permissionDecision\": \"allow\",\n    \"permissionDecisionReason\": \"Command modified for safety\",\n    \"updatedInput\": {\n      \"command\": \"rm -rf ./temp/*\"\n    }\n  }\n}\n```\n\n## Implementation\n\n### pre_tool_use.py\n\n```python\n#!/usr/bin/env python3\n\"\"\"\nPreToolUse safety hook for Claude Code in Google Colab.\nBlocks dangerous bash commands that could cause harm.\n\"\"\"\nimport json\nimport re\nimport sys\n\n# Patterns that should be blocked (with explanations for Claude)\nBLOCKED_PATTERNS = [\n    # Filesystem destruction\n    (r'\\brm\\s+(-[rf]+\\s+)*[/~]$', \n     \"Refusing to delete root or home directory\"),\n    (r'\\brm\\s+(-[rf]+\\s+)*/content/drive\\b',\n     \"Refusing to delete Google Drive contents - this causes permanent data loss\"),\n    (r'\\brm\\s+(-[rf]+\\s+)*~/',\n     \"Refusing to delete home directory contents\"),\n    \n    # Block device operations\n    (r'\u003e\\s*/dev/sd[a-z]',\n     \"Refusing to write directly to block devices\"),\n    (r'\\bmkfs\\b',\n     \"Refusing to format filesystems\"),\n    (r'\\bdd\\s+.*of=/dev/',\n     \"Refusing to write to block devices with dd\"),\n    \n    # Dangerous system operations\n    (r'\\b(shutdown|reboot|halt|poweroff)\\b',\n     \"Refusing to shutdown/reboot the system\"),\n    (r'\\bkill\\s+-9\\s+-1\\b',\n     \"Refusing to kill all processes\"),\n    (r'\\bchmod\\s+(-R\\s+)?777\\s+/',\n     \"Refusing to chmod 777 system directories\"),\n    \n    # Credential exfiltration\n    (r'\\bcurl\\b.*\\|\\s*bash',\n     \"Refusing to pipe curl to bash - review the script first\"),\n    (r'\\bwget\\b.*\\|\\s*bash',\n     \"Refusing to pipe wget to bash - review the script first\"),\n    \n    # Fork bombs and resource exhaustion\n    (r':\\(\\)\\s*{\\s*:\\|:\u0026\\s*};\\s*:',\n     \"Refusing to execute fork bomb\"),\n]\n\n# Patterns that should trigger a warning but not block\nWARNING_PATTERNS = [\n    (r'\\brm\\s+-rf?\\s+\\.',\n     \"⚠️ Deleting from current directory - make sure this is intended\"),\n    (r'\\bgit\\s+push\\s+.*--force',\n     \"⚠️ Force pushing to git - this rewrites history\"),\n    (r'\\bchmod\\s+777\\b',\n     \"⚠️ Setting 777 permissions - consider more restrictive permissions\"),\n]\n\ndef check_command(command: str) -\u003e tuple[bool, str]:\n    \"\"\"\n    Check if command should be blocked.\n    Returns (should_block, message).\n    \"\"\"\n    # Normalize command (handle line continuations, etc.)\n    normalized = ' '.join(command.split())\n    \n    for pattern, message in BLOCKED_PATTERNS:\n        if re.search(pattern, normalized, re.IGNORECASE):\n            return True, message\n    \n    return False, \"\"\n\ndef check_warnings(command: str) -\u003e list[str]:\n    \"\"\"Return list of warnings for concerning patterns.\"\"\"\n    warnings = []\n    normalized = ' '.join(command.split())\n    \n    for pattern, message in WARNING_PATTERNS:\n        if re.search(pattern, normalized, re.IGNORECASE):\n            warnings.append(message)\n    \n    return warnings\n\ndef main():\n    try:\n        input_data = json.load(sys.stdin)\n    except json.JSONDecodeError:\n        sys.exit(0)  # Allow on parse error (fail open for usability)\n    \n    tool_name = input_data.get('tool_name', '')\n    tool_input = input_data.get('tool_input', {})\n    \n    # Only check Bash commands\n    if tool_name != 'Bash':\n        sys.exit(0)\n    \n    command = tool_input.get('command', '')\n    if not command:\n        sys.exit(0)\n    \n    # Check for blocked patterns\n    should_block, message = check_command(command)\n    if should_block:\n        print(f\"BLOCKED: {message}\", file=sys.stderr)\n        print(f\"Command was: {command[:100]}{'...' if len(command) \u003e 100 else ''}\", file=sys.stderr)\n        sys.exit(2)\n    \n    # Check for warnings (don't block, but inform)\n    warnings = check_warnings(command)\n    if warnings:\n        # Output warnings as JSON with allow decision\n        output = {\n            \"hookSpecificOutput\": {\n                \"hookEventName\": \"PreToolUse\",\n                \"permissionDecision\": \"allow\",\n                \"permissionDecisionReason\": \"; \".join(warnings)\n            },\n            \"systemMessage\": \"\\n\".join(warnings)\n        }\n        print(json.dumps(output))\n        sys.exit(0)\n    \n    # Allow command\n    sys.exit(0)\n\nif __name__ == '__main__':\n    main()\n```\n\n## Hook Configuration (hooks.json fragment)\n\n```json\n{\n  \"PreToolUse\": [\n    {\n      \"matcher\": \"Bash\",\n      \"hooks\": [\n        {\n          \"type\": \"command\",\n          \"command\": \"${CLAUDE_PLUGIN_ROOT}/hooks/pre_tool_use.py\",\n          \"timeout\": 5\n        }\n      ]\n    }\n  ]\n}\n```\n\n## Integration Points\n\n### 1. Exit Code Behavior\n| Exit Code | Effect | Message Source |\n|-----------|--------|----------------|\n| 0 | Allow command | stdout (JSON) shown in verbose mode |\n| 2 | Block command | stderr shown to Claude |\n| Other | Non-blocking error | stderr shown in verbose mode |\n\n### 2. Decision Flow\n```\nPreToolUse fires → Hook runs → Exit code checked\n                                    ↓\n                    0 → Check JSON → permissionDecision?\n                                         ↓\n                                    allow/deny/ask\n                    2 → Block, stderr to Claude\n                    other → Log warning, continue\n```\n\n### 3. Parallel Execution\n- Multiple PreToolUse hooks run in parallel\n- Any hook returning exit 2 blocks the command\n- All hooks must allow for command to proceed\n\n## Edge Cases\n\n1. **Command with Pipes/Subshells**\n   ```bash\n   echo \"data\" | rm -rf /  # Pattern matching needs to catch this\n   $(cat evil.sh)          # Subshell execution\n   ```\n   - Parse command more carefully\n   - Consider blocking complex command chains for review\n\n2. **Encoded Commands**\n   ```bash\n   base64 -d \u003c\u003c\u003c \"cm0gLXJmIC8=\" | bash\n   ```\n   - Can't catch all obfuscation\n   - Document that this is best-effort protection\n\n3. **Environment Variable Expansion**\n   ```bash\n   rm -rf $DANGEROUS_PATH\n   ```\n   - Can't expand variables at hook time\n   - Focus on literal dangerous patterns\n\n4. **Legitimate Use Cases**\n   ```bash\n   rm -rf ./build/  # Should be allowed\n   rm -rf /tmp/test/  # Probably fine\n   ```\n   - Pattern matching should be precise\n   - Use anchors and word boundaries\n\n5. **Hook Timeout**\n   - Set low timeout (5s) to not delay execution\n   - Fail open on timeout (allow command)\n\n## Security Considerations\n\n- **Fail Open**: If hook crashes, command proceeds (usability \u003e security for Colab)\n- **Not Bulletproof**: Determined user can bypass (that's okay, it's their env)\n- **Drive Protection**: Most important - prevent accidental Drive deletion\n- **Logging**: Consider logging blocked commands for debugging\n\n## Testing\n\n```bash\n# Test blocked command\necho '{\"tool_name\":\"Bash\",\"tool_input\":{\"command\":\"rm -rf /\"}}' | python3 pre_tool_use.py\necho $?  # Should be 2\n\n# Test allowed command  \necho '{\"tool_name\":\"Bash\",\"tool_input\":{\"command\":\"ls -la\"}}' | python3 pre_tool_use.py\necho $?  # Should be 0\n\n# Test Drive protection\necho '{\"tool_name\":\"Bash\",\"tool_input\":{\"command\":\"rm -rf /content/drive/*\"}}' | python3 pre_tool_use.py\necho $?  # Should be 2\n```\n\n## Files to Create\n- `src/plugin/hooks/pre_tool_use.py`\n- Update `src/plugin/hooks/hooks.json` with PreToolUse config","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-14T18:00:59.240683-05:00","updated_at":"2025-12-14T21:07:43.940749-05:00","dependencies":[{"issue_id":"cc-safety-hook","depends_on_id":"cc-settings","type":"blocks","created_at":"2025-12-14T18:00:59.241836-05:00","created_by":"daemon"}]}
{"id":"cc-session-hook","title":"SessionStart hook for Colab environment setup","description":"**Start by reading:** `src/cached_docs/hooks.md` (focus on SessionStart section, lines 386-440)\n\nCreate a SessionStart hook that eliminates manual `source ~/.bashrc`:\n\n**Implementation:**\n- Use `CLAUDE_ENV_FILE` environment variable to persist env vars\n- Write PATH setup to env file: `$HOME/.local/bin:$HOME/.claude/bin:$PATH`\n- Handle matchers: `startup`, `resume`, `clear`\n- Inject Colab context into Claude's awareness via `additionalContext` JSON output\n\n**Output JSON structure:**\n```json\n{\n  \"hookSpecificOutput\": {\n    \"hookEventName\": \"SessionStart\",\n    \"additionalContext\": \"[Colab] Session started. Storage: ephemeral. GPU: ...\"\n  }\n}\n```\n\n**Files to create/modify:**\n- `src/hooks/session_start.py` - New hook script\n- `build.py` - Include in generated notebook\n- Update settings.json hooks section\n\n---\n\n## ALTERNATIVE PATHS \u0026 EDGE CASES\n\n### Edge Cases to Handle\n\n1. **CLAUDE_ENV_FILE Not Available**\n   Per docs (line 439-440): `CLAUDE_ENV_FILE is only available for SessionStart hooks`\n   - Check for existence before writing: `if [ -n \"$CLAUDE_ENV_FILE\" ]`\n   - Fallback: print warning message to stderr\n\n2. **Resume vs Startup Matchers**\n   Different behavior needed:\n   - `startup`: Full environment setup, inject context\n   - `resume`: Lighter touch, don't repeat context injection\n   - `clear`: Re-inject context since conversation was cleared\n   - `compact`: Don't inject (context already in summary)\n\n3. **Environment Already Configured**\n   - Check if PATH already contains .local/bin before adding\n   - Avoid duplicate entries in CLAUDE_ENV_FILE\n   - Idempotent writes: `grep -q` before appending\n\n4. **GPU Detection Failure**\n   - nvidia-smi might not exist or fail\n   - CUDA might be present but not working\n   - Fallback context: \"GPU: unknown (check with nvidia-smi)\"\n\n5. **Hook Timeout**\n   - Default is 60 seconds, but GPU detection can be slow\n   - Keep hook execution under 5 seconds\n   - Cache expensive operations if possible\n\n### Alternative Implementations\n\n1. **Bash vs Python Hook**\n   \n   **Bash (simpler):**\n   ```bash\n   #\\!/bin/bash\n   input=$(cat)\n   source=$(echo \"$input\" | jq -r '.source')\n   \n   if [ -n \"$CLAUDE_ENV_FILE\" ]; then\n     echo 'export PATH=\"$HOME/.local/bin:$HOME/.claude/bin:$PATH\"' \u003e\u003e \"$CLAUDE_ENV_FILE\"\n   fi\n   \n   if [ \"$source\" = \"startup\" ]; then\n     # Build context JSON\n     echo '{\"hookSpecificOutput\":{\"hookEventName\":\"SessionStart\",\"additionalContext\":\"Colab ready\"}}'\n   fi\n   ```\n   \n   **Python (more robust):**\n   - Better JSON handling\n   - Cleaner error handling\n   - Easier to test\n\n2. **Context Injection Strategies**\n   \n   **Option A: Minimal Context**\n   Just storage mode and GPU status\n   \n   **Option B: Rich Context**\n   Include installed packages, workspace path, project type\n   \n   **Option C: Dynamic Context**\n   Read from ENVIRONMENT.json if exists\n\n3. **Environment Persistence Approaches**\n   \n   **Direct append:**\n   ```bash\n   echo 'export VAR=value' \u003e\u003e \"$CLAUDE_ENV_FILE\"\n   ```\n   \n   **Diff-based (per docs line 417-434):**\n   Capture environment before/after and write diff\n\n### Error Handling\n\n1. **JSON Parsing Errors**\n   ```python\n   try:\n       input_data = json.load(sys.stdin)\n   except json.JSONDecodeError:\n       print('{\"hookSpecificOutput\":{\"hookEventName\":\"SessionStart\",\"additionalContext\":\"SessionStart hook: JSON parse error\"}}')\n       sys.exit(0)\n   ```\n\n2. **File Write Errors**\n   - CLAUDE_ENV_FILE path might be read-only\n   - Handle PermissionError gracefully\n\n3. **Exit Codes**\n   - Exit 0 = success, stdout processed\n   - Exit 2 = blocking error (shouldn't use for SessionStart)\n   - Other = non-blocking error, stderr logged\n\n### Configuration Options\n\n```json\n{\n  \"hooks\": {\n    \"SessionStart\": [\n      {\n        \"matcher\": \"startup|resume|clear\",\n        \"hooks\": [\n          {\n            \"type\": \"command\",\n            \"command\": \"${CLAUDE_PLUGIN_ROOT}/hooks/session_start.py\",\n            \"timeout\": 10\n          }\n        ]\n      }\n    ]\n  }\n}\n```\n\n### Testing Requirements\n\n- Test with `claude --debug` to see hook execution\n- Verify environment variables persist to subsequent Bash calls\n- Test each matcher: startup, resume, clear, compact\n- Test without CLAUDE_ENV_FILE (should not crash)\n- Test with malformed JSON input\n\nDepends on (1):\n  → claude-collab-settings: Enhanced settings.json configuration for Colab [P1]\n\nBlocks (1):\n  ← claude-collab-plugin: Restructure as plugin with repo as marketplace [P1]","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-14T18:00:54.235752-05:00","updated_at":"2025-12-15T01:11:13.04962-05:00","closed_at":"2025-12-15T01:11:13.04962-05:00","dependencies":[{"issue_id":"cc-session-hook","depends_on_id":"cc-settings","type":"blocks","created_at":"2025-12-14T18:00:54.237039-05:00","created_by":"daemon"}]}
{"id":"cc-settings","title":"Enhanced settings.json configuration for Colab","description":"**Start by reading:** `src/cached_docs/settings.md`\n\nAdd comprehensive settings to the bootstrap's generated `settings.json`:\n\n**Permissions to add:**\n- `allow`: Bash(pip:*), Bash(python:*), Bash(git:*), Bash(nvidia-smi), Bash(wget:*), Bash(curl:*), Read(*), Write(*.py), Write(*.md), Write(*.ipynb)\n- `deny`: Bash(rm -rf /), Read(.env), Read(.env.*), Read(**/secrets/**), Read(**/.credentials*)\n\n**Environment variables:**\n- Set TERM, COLORTERM, FORCE_COLOR in settings.env (more reliable than bashrc)\n\n**Other settings:**\n- Disable attribution (commit: \"\", pr: \"\") for cleaner notebook commits\n- Do NOT hardcode model version\n\n**Files to modify:**\n- `build.py` - Update settings generation\n- `src/bootstrap_template.ipynb` - Update install_hooks cell","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-14T18:00:51.711693-05:00","updated_at":"2025-12-15T01:11:13.050698-05:00","closed_at":"2025-12-15T01:11:13.050698-05:00"}
{"id":"cc-statusline","title":"Enhanced status line with context usage and cost","description":"**Start by reading:** `src/cached_docs/statusline.md`\n\nEnhance `src/hooks/statusline.py` to show more useful info for Colab users.\n\n## Dependencies \u0026 Integration Analysis\n\n### External Dependencies\n1. **Claude Code Status Line System**\n   - Script receives JSON via stdin on each update\n   - First line of stdout becomes status line\n   - ANSI colors supported\n   - Updates at most every 300ms\n\n2. **JSON Input Fields** (from Claude Code)\n   ```json\n   {\n     \"model\": {\"id\": \"...\", \"display_name\": \"Sonnet\"},\n     \"workspace\": {\"current_dir\": \"...\", \"project_dir\": \"...\"},\n     \"cost\": {\"total_cost_usd\": 0.0123},\n     \"context_window\": {\n       \"total_input_tokens\": 15000,\n       \"total_output_tokens\": 4500,\n       \"context_window_size\": 200000\n     }\n   }\n   ```\n\n3. **Terminal Color Support**\n   - ANSI escape codes for colors\n   - Colab terminal supports 256 colors\n   - FORCE_COLOR=1 should be set\n\n### Internal Dependencies\n- **claude-collab-settings** (P1): statusLine config in settings.json\n- Existing `src/hooks/statusline.py` as base\n\n### What Depends On This\n- **claude-collab-plugin** (P1): Bundles this script\n- User's visual feedback during sessions\n\n## Current vs Enhanced Status Line\n\n### Current (src/hooks/statusline.py)\n```\nSonnet | workspace_name\n```\n\n### Enhanced (Goal)\n```\nSonnet | 45% ████░░░░ | $0.023 | workspace_name\n       │      │           │          └── Current directory\n       │      │           └── Session cost\n       │      └── Context usage (colored bar)\n       └── Model name\n```\n\n## Implementation\n\n### statusline.py (Enhanced)\n\n```python\n#!/usr/bin/env python3\n\"\"\"\nEnhanced status line for Claude Code in Google Colab.\nShows model, context usage, cost, and directory.\n\"\"\"\nimport json\nimport os\nimport sys\n\n# ANSI color codes\nRESET = '\\033[0m'\nBOLD = '\\033[1m'\nGREEN = '\\033[32m'\nYELLOW = '\\033[33m'\nRED = '\\033[31m'\nCYAN = '\\033[36m'\nDIM = '\\033[2m'\n\ndef get_usage_color(percent: float) -\u003e str:\n    \"\"\"Get color based on context usage percentage.\"\"\"\n    if percent \u003c 50:\n        return GREEN\n    elif percent \u003c 80:\n        return YELLOW\n    else:\n        return RED\n\ndef format_bar(percent: float, width: int = 8) -\u003e str:\n    \"\"\"Create a progress bar with color.\"\"\"\n    filled = int(percent / 100 * width)\n    empty = width - filled\n    color = get_usage_color(percent)\n    return f\"{color}{'█' * filled}{'░' * empty}{RESET}\"\n\ndef format_cost(cost: float) -\u003e str:\n    \"\"\"Format cost with appropriate precision.\"\"\"\n    if cost \u003c 0.01:\n        return f\"${cost:.4f}\"\n    elif cost \u003c 0.1:\n        return f\"${cost:.3f}\"\n    elif cost \u003c 1:\n        return f\"${cost:.2f}\"\n    else:\n        return f\"${cost:.2f}\"\n\ndef main():\n    try:\n        data = json.load(sys.stdin)\n    except (json.JSONDecodeError, Exception):\n        # Fallback if JSON parsing fails\n        print(f\"Claude Code | {os.path.basename(os.getcwd())}\")\n        return\n\n    # Extract values with defaults\n    model = data.get('model', {}).get('display_name', 'Claude')\n    cwd = data.get('workspace', {}).get('current_dir', os.getcwd())\n    project_dir = data.get('workspace', {}).get('project_dir', cwd)\n    \n    # Context window usage\n    ctx = data.get('context_window', {})\n    input_tokens = ctx.get('total_input_tokens', 0)\n    output_tokens = ctx.get('total_output_tokens', 0)\n    window_size = ctx.get('context_window_size', 200000)\n    \n    total_tokens = input_tokens + output_tokens\n    usage_percent = min(100, (total_tokens / window_size) * 100) if window_size \u003e 0 else 0\n    \n    # Cost\n    cost = data.get('cost', {}).get('total_cost_usd', 0)\n    \n    # Format directory (show just basename, with project indicator if different)\n    cwd_short = os.path.basename(cwd) if cwd != \"/\" else \"/\"\n    project_short = os.path.basename(project_dir) if project_dir != \"/\" else \"/\"\n    \n    # Build status line\n    parts = []\n    \n    # Model (green)\n    parts.append(f\"{GREEN}{model}{RESET}\")\n    \n    # Context usage (colored bar + percentage)\n    bar = format_bar(usage_percent)\n    usage_color = get_usage_color(usage_percent)\n    parts.append(f\"{bar} {usage_color}{usage_percent:.0f}%{RESET}\")\n    \n    # Cost (dim if zero)\n    cost_str = format_cost(cost)\n    if cost \u003c 0.001:\n        parts.append(f\"{DIM}{cost_str}{RESET}\")\n    else:\n        parts.append(f\"{CYAN}{cost_str}{RESET}\")\n    \n    # Directory\n    dir_display = cwd_short\n    if cwd_short != project_short:\n        dir_display = f\"{cwd_short} {DIM}({project_short}){RESET}\"\n    parts.append(dir_display)\n    \n    # Join with separator\n    status = \" │ \".join(parts)\n    print(status)\n\nif __name__ == '__main__':\n    main()\n```\n\n## Configuration (settings.json)\n\n```json\n{\n  \"statusLine\": {\n    \"type\": \"command\",\n    \"command\": \"${CLAUDE_PLUGIN_ROOT}/hooks/statusline.py\",\n    \"padding\": 0\n  }\n}\n```\n\n## Integration Points\n\n### 1. Status Line Update Cycle\n```\nClaude Code message update\n        ↓\nJSON sent to statusline script (stdin)\n        ↓\nScript outputs first line (stdout)\n        ↓\nStatus line rendered in terminal\n        ↓\n(max every 300ms)\n```\n\n### 2. JSON Input Schema\nAll available fields from Claude Code:\n```python\ndata = {\n    \"hook_event_name\": \"Status\",\n    \"session_id\": str,\n    \"transcript_path\": str,\n    \"cwd\": str,\n    \"model\": {\n        \"id\": str,           # e.g., \"claude-sonnet-4-5-20250929\"\n        \"display_name\": str  # e.g., \"Sonnet\"\n    },\n    \"workspace\": {\n        \"current_dir\": str,\n        \"project_dir\": str\n    },\n    \"version\": str,\n    \"output_style\": {\"name\": str},\n    \"cost\": {\n        \"total_cost_usd\": float,\n        \"total_duration_ms\": int,\n        \"total_api_duration_ms\": int,\n        \"total_lines_added\": int,\n        \"total_lines_removed\": int\n    },\n    \"context_window\": {\n        \"total_input_tokens\": int,\n        \"total_output_tokens\": int,\n        \"context_window_size\": int\n    }\n}\n```\n\n### 3. Color Coding Logic\n| Usage | Color | Meaning |\n|-------|-------|---------|\n| \u003c50% | Green | Plenty of context remaining |\n| 50-80% | Yellow | Consider compacting soon |\n| \u003e80% | Red | Context nearly full, compact now |\n\n## Colab-Specific Considerations\n\n### Why This Matters for Colab Users\n1. **Cost Awareness**: API billing, need to track spending\n2. **Context Limits**: Notebook workflows fill context fast (cell outputs)\n3. **Model Switching**: Visual indicator of current model tier\n\n### Display Width\n- Colab terminal is typically 80-120 chars wide\n- Status line should be concise\n- Full display: ~50 chars\n- Minimal display if space constrained: ~30 chars\n\n## Edge Cases\n\n1. **No Cost Data**\n   - Show `$0.0000` or hide cost section\n   - Don't crash, use defaults\n\n2. **Missing Context Window Data**\n   - Assume 200k context (Sonnet default)\n   - Show 0% if no token counts\n\n3. **Very Long Directory Names**\n   - Truncate to 20 chars with ellipsis\n   - Or just show basename\n\n4. **Unicode Support**\n   - Test bar characters (█░) in Colab terminal\n   - Fallback to ASCII if needed ([###...])\n\n5. **Rapid Updates**\n   - Script must be fast (\u003c50ms)\n   - Use minimal I/O, no network calls\n\n## Testing\n\n```bash\n# Test with mock input\necho '{\"model\":{\"display_name\":\"Sonnet\"},\"context_window\":{\"total_input_tokens\":50000,\"total_output_tokens\":10000,\"context_window_size\":200000},\"cost\":{\"total_cost_usd\":0.0234},\"workspace\":{\"current_dir\":\"/content/project\",\"project_dir\":\"/content/project\"}}' | python3 statusline.py\n\n# Test edge cases\necho '{}' | python3 statusline.py\necho '{\"model\":{}}' | python3 statusline.py\n\n# Verify colors render\npython3 statusline.py \u003c test_input.json\n```\n\n## Files to Modify\n- `src/hooks/statusline.py` → `src/plugin/hooks/statusline.py`\n- Update hooks.json or settings.json with statusLine config","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-14T18:00:56.769384-05:00","updated_at":"2025-12-14T21:08:33.267991-05:00"}
