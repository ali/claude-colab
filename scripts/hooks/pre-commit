#!/bin/sh
# bd-hooks-version: 0.29.0
#
# bd (beads) pre-commit hook
#
# This hook ensures that any pending bd issue changes are flushed to
# .beads/beads.jsonl before the commit is created, preventing the
# race condition where daemon auto-flush fires after the commit.
#
# When sync-branch is configured in config.yaml, .beads changes are committed
# to a separate branch via worktree, so auto-staging is skipped.
#
# Installation:
#   cp examples/git-hooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# Or use the install script:
#   examples/git-hooks/install.sh

# Check if bd is available
if ! command -v bd >/dev/null 2>&1; then
    echo "Warning: bd command not found, skipping pre-commit flush" >&2
    exit 0
fi

# Check if we're in a bd workspace
if [ ! -d .beads ]; then
    # Not a bd workspace, nothing to do
    exit 0
fi

# Check if sync-branch is configured in config.yaml or env var
# If so, .beads changes go to a separate branch via worktree, not the current branch
SYNC_BRANCH="${BEADS_SYNC_BRANCH:-}"
if [ -z "$SYNC_BRANCH" ] && [ -f .beads/config.yaml ]; then
    # Extract sync-branch value from YAML (handles quoted and unquoted values)
    # Use head -1 to only take first match if file is malformed
    SYNC_BRANCH=$(grep -E '^sync-branch:' .beads/config.yaml 2>/dev/null | head -1 | sed 's/^sync-branch:[[:space:]]*//' | sed 's/^["'"'"']//' | sed 's/["'"'"']$//')
fi
if [ -n "$SYNC_BRANCH" ]; then
    # sync-branch is configured, skip flush and auto-staging
    # Changes are synced to the separate branch via 'bd sync'
    exit 0
fi

# Flush pending changes to JSONL
# Use --flush-only to skip git operations (we're already in a git hook)
# Suppress output unless there's an error
if ! bd sync --flush-only >/dev/null 2>&1; then
    echo "Error: Failed to flush bd changes to JSONL" >&2
    echo "Run 'bd sync --flush-only' manually to diagnose" >&2
    exit 1
fi

# Stage all tracked JSONL files (beads.jsonl, issues.jsonl for backward compat, deletions.jsonl for deletion propagation)
# git add is harmless if file doesn't exist
for f in .beads/beads.jsonl .beads/issues.jsonl .beads/deletions.jsonl; do
    [ -f "$f" ] && git add "$f" 2>/dev/null || true
done

# Run lint/format checks on Python files
# Get list of staged Python files
STAGED_PYTHON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(py)$' || true)

if [ -n "$STAGED_PYTHON_FILES" ]; then
    echo "Running lint/format checks on Python files..."
    
    # Check if uv is available (preferred)
    if command -v uv >/dev/null 2>&1; then
        # Auto-format with ruff format
        echo "  Formatting with ruff format..."
        echo "$STAGED_PYTHON_FILES" | xargs -r uv run ruff format --quiet || {
            echo "❌ Ruff formatting failed." >&2
            exit 1
        }
        
        # Auto-fix linting issues with ruff
        echo "  Linting with ruff check (auto-fixing)..."
        echo "$STAGED_PYTHON_FILES" | xargs -r uv run ruff check --fix --quiet || {
            echo "❌ Ruff linting failed (some issues may require manual fixes)." >&2
            echo "$STAGED_PYTHON_FILES" | xargs -r uv run ruff check >&2
            exit 1
        }
        
        # Re-stage auto-fixed files
        echo "$STAGED_PYTHON_FILES" | xargs -r git add -u
    # Fallback to direct commands if uv not available
    elif command -v ruff >/dev/null 2>&1; then
        echo "  Formatting with ruff format..."
        echo "$STAGED_PYTHON_FILES" | xargs -r ruff format --quiet || {
            echo "❌ Ruff formatting failed." >&2
            exit 1
        }
        
        echo "  Linting with ruff check (auto-fixing)..."
        echo "$STAGED_PYTHON_FILES" | xargs -r ruff check --fix --quiet || {
            echo "❌ Ruff linting failed (some issues may require manual fixes)." >&2
            echo "$STAGED_PYTHON_FILES" | xargs -r ruff check >&2
            exit 1
        }
        
        # Re-stage auto-fixed files
        echo "$STAGED_PYTHON_FILES" | xargs -r git add -u
    else
        echo "Warning: uv or ruff not found. Skipping lint/format checks." >&2
    fi
    
    echo "✓ Lint/format checks passed"
fi

exit 0
